const AUDIOMIMES=["audio/wav","audio/mpeg","audio/ogg","audio/webm","audio/mp4","audio/aac","audio/aacp","audio/flac","audio/ogg","audio/mp3"],IMAGEMIMES=["image/apng","image/bmp","image/gif","image/x-icon","image/jpeg","image/png","image/svg+xml","image/tiff","image/webp"];async function fetchFile(a){let b=await fetch(a),c=await b.text();return c}async function fetchContentType(a){let b=null;try{b=await fetch(a)}catch(a){return console.log(a),""}if(b){let a=b.headers.get("Content-Type");return-1==a.indexOf(";")?a:a.split(";")[0]}return""}function isValidLanguageTag(a){return!("string"!=typeof a)&&/^(?:(en-GB-oed|i-ami|i-bnn|i-default|i-enochian|i-hak|i-klingon|i-lux|i-mingo|i-navajo|i-pwn|i-tao|i-tay|i-tsu|sgn-BE-FR|sgn-BE-NL|sgn-CH-DE)|(art-lojban|cel-gaulish|no-bok|no-nyn|zh-guoyu|zh-hakka|zh-min|zh-min-nan|zh-xiang))$|^((?:[a-z]{2,3}(?:(?:-[a-z]{3}){1,3})?)|[a-z]{4}|[a-z]{5,8})(?:-([a-z]{4}))?(?:-([a-z]{2}|\d{3}))?((?:-(?:[\da-z]{5,8}|\d[\da-z]{3}))*)?((?:-[\da-wy-z](?:-[\da-z]{2,8})+)*)?(-x(?:-[\da-z]{1,8})+)?$|^(x(?:-[\da-z]{1,8})+)$/i.test(a)}function isAudioFormat(a){return AUDIOMIMES.includes(a)}function isImageFormat(a){return IMAGEMIMES.includes(a)}function isValidDuration(a){if("string"!=typeof a)return!1;if(4>a.length)return!1;if("PT"!=a.substr(0,2))return!1;if("S"!=a[a.length-1])return!1;let b=parseInt(a.substr(2,a.length-3));return!isNaN(b)}function getDuration(a){if(isValidDuration(a)){let b=parseInt(a.substr(2,a.length-3));return isNaN(b)?-1:b}return-1}function isValidDate(a){let b=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/.test(a);return b}const TermDefs={ARRAY_OF_LITERALS:["accessMode","accessibilityFeature","accessibilityHazard","inLanguage","uniqueResources","rel","type","conformsTo"],ARRAY_OF_LINKED_RESOURCES:["readingOrder","resources","links","alternate"],ARRAY_OF_L10N_STRINGS:["accessibilitySummary","name","description"],ARRAY_OF_ENTITIES:["artist","author","colorist","contributor","creator","editor","illustrator","inker","letterer","penciler","publisher","readBy","translator"],ARRAY_OF_OBJECTS:["accessModeSufficient"],IDENTIFIERS:["id"],URLS:["url"],LITERALS:["duration","dateModified","datePublished","readingProgression","license"],BOOLEANS:["abridged"]};function normalizeData(a,b,c,d,e){if("@context"==a)return{success:!1,value:null};if(TermDefs.ARRAY_OF_LITERALS.includes(a))return{success:!0,value:"string"==typeof b?[b]:b};if(TermDefs.ARRAY_OF_ENTITIES.includes(a)){if("string"==typeof b||b instanceof Array){let a="string"==typeof b?[{name:b}]:b,c=a.map(a=>{if("string"==typeof a||a instanceof Object){let b="string"==typeof a?{name:a}:a;return b.hasOwnProperty("type")?"string"==typeof b.type&&(b={...b,type:[b.type]}):b={...b,type:["Person"]},b.type.includes("Person")||(b={...b,type:b.type.concat("Person")}),b}return null});return c=c.filter(a=>null!=a),{success:!0,value:c}}return{success:!1,value:null}}if(TermDefs.ARRAY_OF_L10N_STRINGS.includes(a)){if("string"==typeof b||b instanceof Array){let a="string"==typeof b?[{value:b}]:b,e=a.map(a=>{if("string"==typeof a||a instanceof Object){let b="string"==typeof a?{value:a}:a;return b.hasOwnProperty("language")||(b={...b,language:c}),b.hasOwnProperty("direction")||(b={...b,direction:d}),""==b.language&&delete b.language,""==b.direction&&delete b.direction,b}return null});return e=e.filter(a=>null!=a),{success:!0,value:e}}return{success:!1,value:null}}if(TermDefs.ARRAY_OF_LINKED_RESOURCES.includes(a)){if("string"==typeof b||b instanceof Array||b instanceof Object){let a="string"==typeof b?[{url:b}]:b;a instanceof Object&&!(a instanceof Array)&&(a=[a]);let f=a.map(a=>{if("string"==typeof a||a instanceof Object){let b="string"==typeof a?{url:a}:a;return b.hasOwnProperty("type")?"string"==typeof b.type&&(b={...b,type:[b.type]}):b={...b,type:["LinkedResource"]},b.type.includes("LinkedResource")||(b={...b,type:b.type.concat("LinkedResource")}),b.hasOwnProperty("url")&&(b.originalUrl=b.url),Object.keys(b).map(a=>{let f=normalizeData(a,b[a],c,d,e);f.success&&(b[a]=f.value)}),b}return null});return f=f.filter(a=>null!=a),{success:!0,value:f}}return{success:!1,value:null}}return TermDefs.URLS.includes(a)?(b=b instanceof Array?b.map(a=>new URL(a,e).href):new URL(b,e).href,{success:!0,value:b}):{success:!0,value:b}}const AUDIO_REQUIRED_PROPERTIES=["abridged","accessMode","accessModeSufficient","accessibilityFeature","accessibilityHazard","accessibilitySummary","author","dateModified","datePublished","id","inLanguage","name","readBy","readingProgression","resources","url"],AUDIOBOOKS_PROFILE="https://www.w3.org/TR/audiobooks/";function dataValidation(a){let b=a,c=[];if(Object.keys(b).map(a=>{let c=globalDataCheck(a,b[a]);b[a]=c.value}),b.profile==AUDIOBOOKS_PROFILE)try{let{data:a,errors:d}=audiobooksDataValidation(b);b=a,c=c.concat(d)}catch(a){c.push({severity:"fatal",msg:`${a}`})}b.hasOwnProperty("type")&&0!=b.type.length||(c.push({severity:"validation",msg:"No type"}),b.type=["CreativeWork"]),b.hasOwnProperty("accessModeSufficient")&&(b.accessModeSufficient=b.accessModeSufficient.filter(a=>a.hasOwnProperty("type")&&"ItemList"!=a.type)),b.hasOwnProperty("id")&&""!=b.id||c.push({severity:"validation",msg:"ID not set"}),b.hasOwnProperty("duration")&&!isValidDuration(b.duration)&&(c.push({severity:"validation",msg:"Invalid value for property \"duration\""}),delete b.duration),b.hasOwnProperty("dateModified")&&!isValidDate(b.dateModified)&&(c.push({severity:"validation",msg:"Invalid value for property \"dateModified\""}),delete b.dateModified),b.hasOwnProperty("datePublished")&&!isValidDate(b.datePublished)&&(c.push({severity:"validation",msg:"Invalid value for property \"datePublished\""}),delete b.datePublished),b.hasOwnProperty("inLanguage")&&(b.inLanguage.filter(a=>!isValidLanguageTag(a)).map(a=>c.push({severity:"validation",msg:`Invalid language tag *${a}*`})),b.inLanguage=b.inLanguage.filter(a=>isValidLanguageTag(a))),b.hasOwnProperty("readingProgression")?!["ltr","rtl"].includes(b.readingProgression)&&(c.push({severity:"validation",msg:`Invalid value for property "readingProgression" *${b.readingProgression}*`}),b.readingProgression="ltr"):b.readingProgression="ltr";let d=[];if(b.hasOwnProperty("readingOrder")&&(d=b.readingOrder.map(a=>{let b=new URL(a.url);return`${b.origin}${b.pathname}`})),b.hasOwnProperty("resources")&&(d=d.concat(b.resources.map(a=>{let b=new URL(a.url);return`${b.origin}${b.pathname}`}))),b.uniqueResources=Array.from(new Set(d)),b.hasOwnProperty("links")){let a=b.links.filter(a=>{a.hasOwnProperty("rel")&&0!=a.rel.length||c.push({severity:"validation",msg:`Link missing property "rel" *${a.url}*`});let d=new URL(a.url),e=`${d.origin}${d.pathname}`;return!b.uniqueResources.includes(e)&&(!(a.hasOwnProperty("rel")&&(a.rel.includes("contents")||a.rel.includes("pagelist")||a.rel.includes("cover")))||(c.push({severity:"validation",msg:`Invalid value for property \"rel\" *cover*`}),!1))});b.links=a}let e=[];return b.hasOwnProperty("readingOrder")&&(e=b.readingOrder),b.hasOwnProperty("resources")&&(e=e.concat(b.resources)),1<e.filter(a=>a.hasOwnProperty("rel")&&a.rel.includes("contents")).length&&c.push({severity:"validation",msg:"Multiple resources with rel=contents"}),1<e.filter(a=>a.hasOwnProperty("rel")&&a.rel.includes("pagelist")).length&&c.push({severity:"validation",msg:"Multiple resources with rel=pagelist"}),1<e.filter(a=>a.hasOwnProperty("rel")&&a.rel.includes("cover")).length&&c.push({severity:"validation",msg:"Multiple resources with rel=cover"}),e.filter(a=>a.hasOwnProperty("rel")&&a.rel.includes("cover")&&isImageFormat(a.encodingFormat)&&!a.hasOwnProperty("name")).map(()=>c.push({severity:"validation",msg:`All image covers must have a "name" property`})),removeEmptyArrays(b),{data:b,errors:c}}function globalDataCheck(a,b){return{success:!0,value:b}}function removeEmptyArrays(a){return!(a instanceof Array&&0==a.length)&&(a instanceof Object&&Object.keys(a).map(b=>{removeEmptyArrays(a[b])||delete a[b]}),!0)}function audiobooksDataValidation(a){let b=a,c=[];if(!b.hasOwnProperty("readingOrder"))throw"Missing property \"readingOrder\"";let d=b.readingOrder.filter(a=>isAudioFormat(a.encodingFormat));if(b.readingOrder.length>d.length&&(c.push({severity:"validation",msg:"Non-audio reading order items encountered"}),b.readingOrder=d),0==b.readingOrder.length)throw"No reading order items available";b.hasOwnProperty("type")&&0!=b.type.length||(c.push({severity:"validation",msg:"Missing property \"type\""}),b.type=["Audiobook"]),AUDIO_REQUIRED_PROPERTIES.filter(a=>!b.hasOwnProperty(a)).map(a=>c.push({severity:"validation",msg:`Missing property "${a}"`}));let e=b.resources.find(a=>!!a.rel&&a.rel.includes("cover"));if(e||c.push({severity:"validation",msg:"Missing \"cover\" resource"}),b.readingOrder&&b.readingOrder.map(a=>{a.hasOwnProperty("duration")?!isValidDuration(a.duration)&&(c.push({severity:"validation",msg:`Reading order item ${a.url} has invalid value for property "duration" *${a.duration}*`}),delete a.duration):c.push({severity:"validation",msg:`Reading order item ${a.url} missing property "duration"`})}),!b.hasOwnProperty("duration"))c.push({severity:"validation",msg:"Missing property \"duration\""});else{let a=b.readingOrder.reduce((a,b)=>(b.hasOwnProperty("duration")&&(a+=getDuration(b.duration)),a),0),d=`PT${a.toString()}S`;d!=b.duration&&c.push({severity:"validation",msg:"Incorrect value for top-level property \"duration\""})}return{data:b,errors:c}}const AUDIOBOOKS_PROFILE$1="https://www.w3.org/TR/audiobooks/";class ManifestProcessor{constructor(){this.errors=[],this.json={},this.processed={},this.supportedProfiles=[],this.defaults={lang:"",dir:"",title:""},this._readingOrderItems=[]}async loadJson(a,b="",c=!1){this.json=a,this.processed.hasOwnProperty("base")||(this.processed.base=""),""==this.processed.base&&""!=b&&(this.processed.base=b);try{this.checkContext(),this.checkReadingOrder()}catch(a){return void this.errors.push({severity:"fatal",msg:`${a}`})}try{await this.setProfile(c)}catch(a){return void this.errors.push({severity:"fatal",msg:`${a}`})}this.setGlobalLangAndDir();let d={...this.json,readingOrder:this._readingOrderItems};if(d.hasOwnProperty("name")||(d.name=""),Object.keys(d).map(a=>{let b=normalizeData(a,d[a],this.processed.lang,this.processed.dir,this.processed.base);b.success&&(this.processed[a]=b.value)}),""==this.processed.name[0].value&&""!=this.defaults.title&&(this.processed.name[0].value=this.defaults.title),this.processed.profile==AUDIOBOOKS_PROFILE$1)try{await this.audiobooksProcessing()}catch(a){this.errors.push({severity:"fatal",msg:`${a}`})}let{data:e,errors:f}=dataValidation(this.processed);this.processed=e,this.errors=this.errors.concat(f)}checkContext(){if(!this.json.hasOwnProperty("@context"))throw"Missing property \"@context\"";else if(!(this.json["@context"]instanceof Array))throw"Property \"@context\" is not an Array";else if(!(2<=this.json["@context"].length))throw"Property @context does not contain the required values";else if("https://schema.org"!=this.json["@context"][0]||"https://www.w3.org/ns/pub-context"!=this.json["@context"][1])throw"Property \"@context\" does not contain the required values"}checkReadingOrder(){if(!this.json.hasOwnProperty("readingOrder"))throw"Missing property \"readingOrder\"";"string"==typeof this.json.readingOrder&&(this.json.readingOrder=[this.json.readingOrder]),this._readingOrderItems=this.json.readingOrder.map(a=>{let b="string"==typeof a?{url:a}:a;return b})}setGlobalLangAndDir(){let a=this.json["@context"].filter(a=>a instanceof Object);a.map(a=>{a.hasOwnProperty("language")&&(this.processed.lang=a.language),a.hasOwnProperty("direction")&&(this.processed.dir=a.direction)}),isValidLanguageTag(this.processed.lang)||(this.errors.push({severity:"validation",msg:`Invalid language tag *${this.processed.lang}*`}),this.processed.lang=""),!1==["rtl","ltr"].includes(this.processed.dir)&&(this.errors.push({severity:"validation",msg:`Invalid direction value *${this.processed.dir}*`}),this.processed.dir=""),""==this.processed.lang&&(this.processed.lang=this.defaults.lang),""==this.processed.dir&&(this.processed.dir=this.defaults.dir)}async setProfile(a=!1){let b=this.json.conformsTo instanceof Array?this.json.conformsTo:[this.json.conformsTo],c=this.supportedProfiles.map(a=>a.id),d=b.find(a=>c.includes(a));if(d)this.processed.profile=d;else if(a){let a=await this.guessProfile();if(a)this.processed.profile=a.id,this.errors.push({severity:"validation",msg:"Had to guess what profile to use"});else throw"Could not determine profile"}else throw"Could not determine profile"}async guessProfile(){console.log("Guessing profile"),this._readingOrderItems=await this.getEncodingFormats(this._readingOrderItems);let a=Array.from(new Set(this._readingOrderItems.map(a=>a.encodingFormat))),b=this.supportedProfiles.find(b=>!a.map(a=>b.encodingFormats.includes(a)).includes(!1));return b==null?null:b}async getEncodingFormats(a){return Promise.all(a.map(async a=>{let b=await fetchContentType(new URL(a.url,this.processed.base));return console.log(b),{...a,encodingFormat:b}}))}async audiobooksProcessing(){let a=this.processed.resources.find(a=>!!a.rel&&a.rel.includes("contents"));if(a!=null){let b=await fetchFile(a.url);const c=new DOMParser,d=c.parseFromString(b,"text/html");this.processed.toc=d.documentElement.querySelector("[role=doc-toc]")!=null}else this.processed.toc=!1;this.processed.toc||this.errors.push({severity:"validation",msg:"No HTML table of contents found"})}}class Manifest{constructor(){this.errors=[],this.data={},this.supportedProfiles=[],this.defaults={lang:"",dir:"",title:""},this.readingOrderIndex=0,this.toc=!1,this.version="0.2.0"}setSupportedProfiles(a){this.supportedProfiles=a}setDefaults(a){this.defaults={...this.defaults,...a}}async loadUrl(a,b=!1){console.log(`Loading manifest ${a}`);let c,d="string"==typeof a?a:a.href,e=d;try{let a=await fetchContentType(d);if("text/html"==a){let a=await fetchFile(d),b=new DOMParser().parseFromString(a,"text/html"),f=b.querySelector("link[rel='publication']");if(null===f)throw"Publication link not found";let g=f.getAttribute("href");if("#"==g[0]){let a=b.querySelector(g);if(null==a)throw`Manifest at ${g} does not exist`;let d=b.querySelector("base");d&&(e=d.getAttribute("href")),c=JSON.parse(a.textContent)}else{let a=new URL(g,d),b=await fetchFile(a);c=JSON.parse(b),e=a}}else if("application/ld+json"==a||"application/json"==a){let a=await fetchFile(d);c=JSON.parse(a)}else throw`Content type *${a}* not recognized`}catch(a){return this.errors.push({severity:"fatal",msg:`${a}`}),void console.log(a)}await this.loadJson(c,e,b)}async loadJson(a,b="",c=!1){let d=new ManifestProcessor;d.supportedProfiles=this.supportedProfiles,d.defaults=this.defaults,await d.loadJson(a,b,c),this.data=d.processed,this.errors=this.errors.concat(d.errors)}getFatalErrors(){return this.errors.filter(a=>"fatal"===a.severity)}getTitle(a=""){return this.getL10NStringValue(this.data.name,a)}getCover(){return this.getResource("cover")}getPageList(){return this.getResource("pagelist")}getToc(){return this.hasHtmlToc()?this.getResource("contents"):this.data.readingOrder?this.data.readingOrder.map(a=>({name:this.getL10NStringValue(a.name),url:a.url})):[]}hasHtmlToc(){return null!=this.getResource("contents")&&"text/html"==this.getResource("contents").encodingFormat}getCurrentReadingOrderItem(){return this.data.readingOrder&&this.data.readingOrder.length>this.readingOrderIndex?this.data.readingOrder[this.readingOrderIndex]:null}gotoNextReadingOrderItem(){return this.readingOrderIndex<this.data.readingOrder.length-1?(this.readingOrderIndex++,this.getCurrentReadingOrderItem()):null}gotoPrevReadingOrderItem(){return 0<this.readingOrderIndex?(this.readingOrderIndex--,this.getCurrentReadingOrderItem()):null}updateCurrentReadingOrderIndex(a){let b=-1==a.indexOf("://")?new URL(a,this.data.base):new URL(a);if(this.data.readingOrder){let a=this.data.readingOrder.findIndex(a=>a.url==b.href);if(-1!=a)return this.readingOrderIndex=a,this.getCurrentReadingOrderItem()}else return null}getResource(a){let b=this.data.resources.find(b=>!!b.rel&&b.rel.includes(a));return b?b:null}getL10NStringValue(a,b=""){if(""!=b){let c=a.find(a=>a.language===b);return c?c.value:a[0].value}if(""!=this.data.lang){let b=a.find(a=>a.language===this.data.lang);if(b)return b.value}return a[0].value}}export{Manifest};