const AUDIOMIMES=["audio/wav","audio/mpeg","audio/ogg","audio/webm","audio/mp4","audio/aac","audio/aacp","audio/flac","audio/ogg","audio/mp3"],IMAGEMIMES=["image/apng","image/bmp","image/gif","image/x-icon","image/jpeg","image/png","image/svg+xml","image/tiff","image/webp"];async function fetchFile(a){let b=await fetch(a);if(b){let a=await b.text();return a}return null}async function fetchContentType(a){let b=null;try{b=await fetch(a)}catch(a){return console.log(a),""}if(b){let a=b.headers.get("Content-Type");return a?-1==a.indexOf(";")?a:a.split(";")[0]:""}return""}function isValidLanguageTag(a){return!("string"!=typeof a)&&/^(?:(en-GB-oed|i-ami|i-bnn|i-default|i-enochian|i-hak|i-klingon|i-lux|i-mingo|i-navajo|i-pwn|i-tao|i-tay|i-tsu|sgn-BE-FR|sgn-BE-NL|sgn-CH-DE)|(art-lojban|cel-gaulish|no-bok|no-nyn|zh-guoyu|zh-hakka|zh-min|zh-min-nan|zh-xiang))$|^((?:[a-z]{2,3}(?:(?:-[a-z]{3}){1,3})?)|[a-z]{4}|[a-z]{5,8})(?:-([a-z]{4}))?(?:-([a-z]{2}|\d{3}))?((?:-(?:[\da-z]{5,8}|\d[\da-z]{3}))*)?((?:-[\da-wy-z](?:-[\da-z]{2,8})+)*)?(-x(?:-[\da-z]{1,8})+)?$|^(x(?:-[\da-z]{1,8})+)$/i.test(a)}function isAudioFormat(a){return AUDIOMIMES.includes(a)}function isImageFormat(a){return IMAGEMIMES.includes(a)}function isValidDuration(a){return!("string"!=typeof a)&&0!=moment.duration(a).asMilliseconds()}function getDurationInSeconds(a){return moment.duration(a).asSeconds()}function isValidDate(a){let b=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/.test(a);return b}const TermDefs={ARRAY_OF_LITERALS:["accessMode","accessibilityFeature","accessibilityHazard","inLanguage","uniqueResources","rel","type","conformsTo"],ARRAY_OF_LINKED_RESOURCES:["readingOrder","resources","links","alternate"],ARRAY_OF_L10N_STRINGS:["accessibilitySummary","name","description"],ARRAY_OF_ENTITIES:["artist","author","colorist","contributor","creator","editor","illustrator","inker","letterer","penciler","publisher","readBy","translator"],ACCESS_MODE_SUFFICIENT:["accessModeSufficient"],IDENTIFIERS:["id"],URLS:["url","id"],LITERALS:["duration","dateModified","datePublished","readingProgression","license"],BOOLEANS:["abridged"]};let errors=[];function normalize(a,b){errors=[];let c=b;return Object.keys(a).map(d=>{let e=normalizeData(d,a[d],b.lang,b.dir);e.success&&(c[d]=e.value)}),{data:c,errors}}function normalizeData(a,b,c,d){if("@context"==a)return{success:!1,value:null,errors};if(TermDefs.ARRAY_OF_LITERALS.includes(a))return{success:!0,value:"string"==typeof b?[b]:b};if(TermDefs.ARRAY_OF_ENTITIES.includes(a)){if("string"==typeof b||b instanceof Array){let a="string"==typeof b?[{name:b}]:b,e=a.map(a=>{if("string"==typeof a||a instanceof Object){let b="string"==typeof a?{name:a}:a;return b.hasOwnProperty("type")?"string"==typeof b.type&&(b={...b,type:[b.type]}):b={...b,type:["Person"]},b.type.includes("Person")||(b={...b,type:b.type.concat("Person")}),b}return null}),f=e.filter(a=>null!=a&&a.hasOwnProperty("name"));f.length!=e.length&&errors.push({severity:"validation",msg:"Entity missing required property 'name'."});let g;for(g=0;g<f.length;g++){let a=normalizeData("name",e[g].name,c,d);a.success&&(f[g].name=a.value)}return{success:!0,value:f}}return{success:!1,value:null}}if(TermDefs.ARRAY_OF_L10N_STRINGS.includes(a)){if("string"==typeof b||b instanceof Array){let a="string"==typeof b?[{value:b}]:b,e=a.map(a=>{if("string"==typeof a||a instanceof Object){let b="string"==typeof a?{value:a}:a;return b.hasOwnProperty("language")||(b={...b,language:c}),b.hasOwnProperty("direction")||(b={...b,direction:d}),""==b.language&&delete b.language,""==b.direction&&delete b.direction,b}return null});return e=e.filter(a=>null!=a),{success:!0,value:e}}return{success:!1,value:null}}if(TermDefs.ARRAY_OF_LINKED_RESOURCES.includes(a)){if("string"==typeof b||b instanceof Array||b instanceof Object){let a="string"==typeof b?[{url:b}]:b;a instanceof Object&&!(a instanceof Array)&&(a=[a]);let e=a.map(a=>{if("string"==typeof a||a instanceof Object){let b="string"==typeof a?{url:a}:a;return b.hasOwnProperty("type")?"string"==typeof b.type&&(b={...b,type:[b.type]}):b={...b,type:["LinkedResource"]},b.type.includes("LinkedResource")||(b={...b,type:b.type.concat("LinkedResource")}),b.hasOwnProperty("url")&&(b.originalUrl=b.url),Object.keys(b).map(a=>{let e=normalizeData(a,b[a],c,d);e.success&&(b[a]=e.value)}),b}return null});return e=e.filter(a=>null!=a),{success:!0,value:e}}return{success:!1,value:null}}return{success:!0,value:b}}let errors$1=[];function globalDataCheck(a){errors$1=[];let b=checkObject(a);return{data:b,errors:errors$1}}function checkObject(a){let b=a;return Object.keys(b).map(a=>{let c=checkTerm(a,b[a]);null==c?(errors$1.push({severity:"validation",msg:`Term ${a} failed global data check and has been removed`}),delete b[a]):b[a]=c}),b}function checkTerm(a,b){if(TermDefs.ARRAY_OF_ENTITIES.includes(a)||TermDefs.ARRAY_OF_L10N_STRINGS.includes(a)||TermDefs.ARRAY_OF_LINKED_RESOURCES.includes(a)||TermDefs.ARRAY_OF_LITERALS.includes(a)){if(!(b instanceof Array))return errors$1.push({severity:"validation",msg:`Array expected for ${a}`}),null;if(TermDefs.ARRAY_OF_ENTITIES.includes(a)||TermDefs.ARRAY_OF_L10N_STRINGS.includes(a)||TermDefs.ARRAY_OF_LINKED_RESOURCES.includes(a)){let a=b.map(a=>checkObject(a)).filter(a=>({})!=a);return 0<a.length?a:null}else{let c=b.filter(a=>"string"==typeof a);return c.length==b.length?b:(errors$1.push({severity:"validation",msg:`Array of literals expected for ${a}`}),c)}}return TermDefs.BOOLEANS.includes(a)?!0!=b&&!1!=b?(errors$1.push({severity:"validation",msg:`Boolean expected for ${a}`}),null):b:TermDefs.IDENTIFIERS.includes(a)||TermDefs.LITERALS.includes(a)||TermDefs.URLS.includes(a)?"string"==typeof b||b instanceof Array?b:(errors$1.push({severity:"validation",msg:`String or Array expected for ${a}`}),null):b}const AUDIO_REQUIRED_PROPERTIES=["abridged","accessMode","accessModeSufficient","accessibilityFeature","accessibilityHazard","accessibilitySummary","author","dateModified","datePublished","id","inLanguage","name","readBy","readingProgression","resources","url"],AUDIOBOOKS_PROFILE="https://www.w3.org/TR/audiobooks/";let errors$2=[];function dataValidation(a){let b=a;if(errors$2=[],b.hasOwnProperty("links")&&(b.links=lowerCaseRel(b.links)),b.hasOwnProperty("readingOrder")&&(b.readingOrder=lowerCaseRel(b.readingOrder)),b.hasOwnProperty("resources")&&(b.resources=lowerCaseRel(b.resources)),b.profile==AUDIOBOOKS_PROFILE)try{let{data:a,errors:c}=audiobooksDataValidation(b);b=a,errors$2=errors$2.concat(c)}catch(a){errors$2.push({severity:"fatal",msg:`${a}`})}if(b.hasOwnProperty("type")&&0!=b.type.length||(errors$2.push({severity:"validation",msg:"No type"}),b.type=["CreativeWork"]),b.hasOwnProperty("accessModeSufficient")){let a=b.accessModeSufficient;a instanceof Array?b.accessModeSufficient=a.filter(a=>!!(a.hasOwnProperty("type")&&"ItemList"===a.type)||(errors$2.push({severity:"validation",msg:`accessModeSufficient requires an array of ItemList objects`}),!1)):(errors$2.push({severity:"validation",msg:`Array expected for accessModeSufficient`}),delete b.accessModeSufficient)}b.hasOwnProperty("id")&&""!=b.id||errors$2.push({severity:"validation",msg:"ID not set"}),b.hasOwnProperty("duration")&&!isValidDuration(b.duration)&&(errors$2.push({severity:"validation",msg:"Invalid value for property \"duration\""}),delete b.duration),b.hasOwnProperty("dateModified")&&!isValidDate(b.dateModified)&&(errors$2.push({severity:"validation",msg:"Invalid value for property \"dateModified\""}),delete b.dateModified),b.hasOwnProperty("datePublished")&&!isValidDate(b.datePublished)&&(errors$2.push({severity:"validation",msg:"Invalid value for property \"datePublished\""}),delete b.datePublished),b.hasOwnProperty("inLanguage")&&(b.inLanguage.filter(a=>!isValidLanguageTag(a)).map(a=>errors$2.push({severity:"validation",msg:`Invalid language tag *${a}*`})),b.inLanguage=b.inLanguage.filter(a=>isValidLanguageTag(a))),b.hasOwnProperty("readingProgression")?!["ltr","rtl"].includes(b.readingProgression)&&(errors$2.push({severity:"validation",msg:`Invalid value for property "readingProgression" *${b.readingProgression}*`}),b.readingProgression="ltr"):b.readingProgression="ltr";let c=[];if(b.hasOwnProperty("readingOrder")&&(c=b.readingOrder.map(a=>{let c=new URL(a.url,b.base);return`${c.origin}${c.pathname}`})),b.hasOwnProperty("resources")&&(c=c.concat(b.resources.map(a=>{let c=new URL(a.url,b.base);return`${c.origin}${c.pathname}`}))),b.uniqueResources=Array.from(new Set(c)),b.hasOwnProperty("links")){let a=b.links.filter(a=>{a.hasOwnProperty("rel")&&0!=a.rel.length||errors$2.push({severity:"validation",msg:`Link missing property "rel" *${a.url}*`});let c=new URL(a.url),d=`${c.origin}${c.pathname}`;return b.uniqueResources.includes(d)?(errors$2.push({severity:"validation",msg:`URL ${a.url} appears in bounds; removed from "links".`}),!1):!(a.hasOwnProperty("rel")&&(a.rel.includes("contents")||a.rel.includes("pagelist")||a.rel.includes("cover")))||(errors$2.push({severity:"validation",msg:`Invalid value for property "rel" in "links" (cannot be "cover", "contents", or "pagelist").`}),!1)});b.links=a}let d=[];if(b.hasOwnProperty("readingOrder")&&(d=b.readingOrder),b.hasOwnProperty("resources")&&(d=d.concat(b.resources)),b.hasOwnProperty("readingOrder")){let a=b.readingOrder.map(a=>{let b=new URL(a.url);return`${b.origin}${b.pathname}`}),c=Array.from(new Set(a));a.length!=c.length&&errors$2.push({severity:"validation",msg:"Reading order contains duplicate URLs"})}if(b.hasOwnProperty("resources")){let a=b.resources.map(a=>{let b=new URL(a.url);return`${b.origin}${b.pathname}`}),c=Array.from(new Set(a));a.length!=c.length&&errors$2.push({severity:"validation",msg:"Resources contain duplicate URLs"})}1<d.filter(a=>a.hasOwnProperty("rel")&&a.rel.includes("contents")).length&&errors$2.push({severity:"validation",msg:"Multiple resources with rel=contents"}),1<d.filter(a=>a.hasOwnProperty("rel")&&a.rel.includes("pagelist")).length&&errors$2.push({severity:"validation",msg:"Multiple resources with rel=pagelist"}),1<d.filter(a=>a.hasOwnProperty("rel")&&a.rel.includes("cover")).length&&errors$2.push({severity:"validation",msg:"Multiple resources with rel=cover"}),d.filter(a=>a.hasOwnProperty("rel")&&a.rel.includes("cover")&&isImageFormat(a.encodingFormat)&&!a.hasOwnProperty("name")).map(()=>errors$2.push({severity:"validation",msg:`All image covers must have a "name" property`})),b.hasOwnProperty("readingOrder")&&(b.readingOrder=validateDurations(b.readingOrder)),b.hasOwnProperty("links")&&(b.links=validateDurations(b.links)),b.hasOwnProperty("resources")&&(b.resources=validateDurations(b.resources)),removeEmptyArrays(b);let{data:e,errors:f}=globalDataCheck(b);return b=e,errors$2=errors$2.concat(f),{data:b,errors:errors$2}}function removeEmptyArrays(a){return!(a instanceof Array&&0==a.length)&&(a instanceof Object&&Object.keys(a).map(b=>{removeEmptyArrays(a[b])||delete a[b]}),!0)}function audiobooksDataValidation(a){let b=a,c=[];if(!b.hasOwnProperty("readingOrder"))throw"Missing property \"readingOrder\"";let d=b.readingOrder.filter(a=>isAudioFormat(a.encodingFormat));if(b.readingOrder.length>d.length&&(c.push({severity:"validation",msg:"Non-audio reading order items encountered"}),b.readingOrder=d),0==b.readingOrder.length)throw"No audio reading order items available.";b.hasOwnProperty("type")&&0!=b.type.length||(c.push({severity:"validation",msg:"Missing property \"type\""}),b.type=["Audiobook"]),AUDIO_REQUIRED_PROPERTIES.filter(a=>!b.hasOwnProperty(a)).map(a=>c.push({severity:"validation",msg:`Missing property "${a}"`}));let e=null;if(b.hasOwnProperty("resources")&&(e=b.resources.find(a=>!!a.rel&&a.rel.includes("cover"))),e||c.push({severity:"validation",msg:"Missing \"cover\" resource"}),b.hasOwnProperty("readingOrder")&&b.readingOrder.map(a=>{a.hasOwnProperty("duration")||c.push({severity:"validation",msg:`Reading order item ${a.url} missing property "duration"`})}),!b.hasOwnProperty("duration"))c.push({severity:"validation",msg:"Missing property \"duration\""});else{let a=b.readingOrder.reduce((a,b)=>(b.hasOwnProperty("duration")&&(a+=getDurationInSeconds(b.duration)),a),0);a!=getDurationInSeconds(b.duration)&&c.push({severity:"validation",msg:"Incorrect value for top-level property \"duration\""})}return{data:b,errors:c}}function lowerCaseRel(a){let b=a.map(a=>a.hasOwnProperty("rel")?{...a,rel:a.rel.map(a=>a.toLowerCase())}:a);return b}function validateDurations(a){let b=a.map(a=>{if(a.hasOwnProperty("duration")){if(!isValidDuration(a.duration)){errors$2.push({severity:"validation",msg:`Linked resource item ${a.url} has invalid value for property "duration" *${a.duration}*`});let b=a;return delete b.duration,b}return a}return a});return b}let errors$3=[];function validateUrlsAndRenormalize(a){return errors$3=[],a=scanProperties(a,a.base),a.hasOwnProperty("links")&&(a.links=removeItemsWithNoUrl(a.links)),a.hasOwnProperty("readingOrder")&&(a.readingOrder=removeItemsWithNoUrl(a.readingOrder)),a.hasOwnProperty("resources")&&(a.resources=removeItemsWithNoUrl(a.resources)),{data:a,errors:errors$3}}function removeItemsWithNoUrl(a){let b=a.filter(a=>a.hasOwnProperty("url"));return b.length!=a.length&&errors$3.push({severity:"validation",msg:"LinkedResource removed"}),b}function scanProperties(a,b){let c=a;return Object.keys(c).map(a=>{if("string"==typeof c[a]&&TermDefs.URLS.includes(a)){let d=checkUrl(c[a],b);d?c[a]=d:delete c[a]}else c[a]instanceof Array?c[a]=c[a].map(c=>"string"==typeof c&&TermDefs.URLS.includes(a)?checkUrl(c,b):c instanceof Object?scanProperties(c,b):c).filter(a=>null!=a):c[a]instanceof Object&&(c[a]=scanProperties(c[a]))}),c}function checkUrl(a,b){let c;try{c=new URL(a,b).href}catch(b){return errors$3.push({severity:"validation",msg:`Invalid URL ${a}`}),null}return c}const AUDIOBOOKS_PROFILE$1="https://www.w3.org/TR/audiobooks/";class ManifestProcessor{constructor(){this.errors=[],this.json={},this.processed={},this.supportedProfiles=[],this.defaults={},this._readingOrderItems=[]}async loadJson(a,b="",c=!1,d=""){this.json=a,this.processed.hasOwnProperty("base")||(this.processed.base=""),""==this.processed.base&&""!=b&&(this.processed.base=b);try{this.checkContext(),this.checkReadingOrder()}catch(a){return void this.errors.push({severity:"fatal",msg:`${a}`})}try{await this.setProfile(c)}catch(a){return void this.errors.push({severity:"fatal",msg:`${a}`})}this.setGlobalLangAndDir();let e={...this.json,readingOrder:this._readingOrderItems};e.hasOwnProperty("name")||(e.name="");let{data:f,errors:g}=normalize(e,this.processed);this.errors=this.errors.concat(g),Object.keys(f).map(a=>this.processed[a]=f[a]),""==this.processed.name[0].value&&(""==this.defaults.title?(this.processed.name[0].value="Publication",this.errors.push({severity:"validation",msg:"No default title found"})):this.processed.name[0].value=this.defaults.title);let{data:h,errors:i}=validateUrlsAndRenormalize(this.processed);this.errors=this.errors.concat(i),this.processed=h;let{data:j,errors:k}=dataValidation(this.processed);if(this.processed=j,this.checkDocumentUrl(d),this.errors=this.errors.concat(k),this.processed.profile==AUDIOBOOKS_PROFILE$1)try{await this.audiobooksProcessing()}catch(a){this.errors.push({severity:"fatal",msg:`${a}`})}}checkContext(){if(!this.json.hasOwnProperty("@context"))throw"Missing property \"@context\"";else if(!(this.json["@context"]instanceof Array))throw"Property \"@context\" is not an Array";else if(!(2<=this.json["@context"].length))throw"Property @context does not contain the required values";else if("https://schema.org"!=this.json["@context"][0]||"https://www.w3.org/ns/pub-context"!=this.json["@context"][1])throw"Property \"@context\" does not contain the required values"}checkReadingOrder(){this.json.hasOwnProperty("readingOrder")||(this.json.readingOrder=[]),"string"==typeof this.json.readingOrder&&(this.json.readingOrder=[this.json.readingOrder]),this._readingOrderItems=this.json.readingOrder.map(a=>{let b="string"==typeof a?{url:a}:a;return b})}setGlobalLangAndDir(){let a=this.json["@context"].filter(a=>a instanceof Object);this.processed.lang="",this.processed.dir="",a.map(a=>{a.hasOwnProperty("language")&&(this.processed.lang=a.language),a.hasOwnProperty("direction")&&(this.processed.dir=a.direction)}),""==this.processed.lang||isValidLanguageTag(this.processed.lang)||(this.errors.push({severity:"validation",msg:`Invalid language tag *${this.processed.lang}*`}),this.processed.lang=""),""!=this.processed.dir&&!1==["rtl","ltr"].includes(this.processed.dir)&&(this.errors.push({severity:"validation",msg:`Invalid direction value *${this.processed.dir}*`}),this.processed.dir=""),""==this.processed.lang&&this.defaults.hasOwnProperty("lang")&&(this.processed.lang=this.defaults.lang),""==this.processed.dir&&this.defaults.hasOwnProperty("dir")&&(this.processed.dir=this.defaults.dir)}async setProfile(a=!1){let b=this.json.conformsTo instanceof Array?this.json.conformsTo:[this.json.conformsTo],c=this.supportedProfiles.map(a=>a.id),d=b.find(a=>c.includes(a));if(d)this.processed.profile=d;else if(a){let a=await this.guessProfile();if(a)this.processed.profile=a.id,this.errors.push({severity:"validation",msg:"Had to guess what profile to use"});else throw"Could not determine profile"}else if(this.defaults.hasOwnProperty("profile"))this.processed.profile=this.defaults.profile,this.errors.push({severity:"validation",msg:"Conformance statement missing; using default profile"});else throw"Could not determine profile, and no default profile was set."}async guessProfile(){console.log("Guessing profile"),this._readingOrderItems=await this.getEncodingFormats(this._readingOrderItems);let a=Array.from(new Set(this._readingOrderItems.map(a=>a.encodingFormat))),b=this.supportedProfiles.find(b=>!a.map(a=>b.encodingFormats.includes(a)).includes(!1));return b==null?null:b}async getEncodingFormats(a){return Promise.all(a.map(async a=>{let b=await fetchContentType(new URL(a.url,this.processed.base));return console.log(b),{...a,encodingFormat:b}}))}async audiobooksProcessing(){if(this.processed.toc=!1,this.processed.hasOwnProperty("resources")){let a=this.processed.resources.find(a=>!!a.rel&&a.rel.includes("contents"));if(null!=a){let b=await fetchFile(a.url);const c=new DOMParser,d=c.parseFromString(b,"text/html");this.processed.toc=null!=d.documentElement.querySelector("[role=doc-toc]")}}this.processed.toc||(this.defaults.toc?this.processed.toc=!0:this.errors.push({severity:"validation",msg:"No HTML table of contents found"}))}checkDocumentUrl(a){!1==this.processed.hasOwnProperty("readingOrder")&&(this.processed.readingOrder=[]),0==this.processed.readingOrder.length?""==a?this.errors.push({severity:"fatal",msg:"No reading order items available."}):(this.defaults.toc?this.processed.readingOrder.push({url:a,rel:"contents"}):this.processed.readingOrder.push({url:a}),this.processed.uniqueResources.push(a)):""!=a&&!1==this.processed.uniqueResources.includes(a)&&this.errors.push({severity:"validation",msg:"Document URL must be included as a reading order entry or resource entry."})}}const VERSION="0.2.5";class Manifest{constructor(){this.errors=[],this.data={},this.supportedProfiles=[],this.defaults={lang:"",dir:"",title:"",toc:null},this.readingOrderIndex=0,this.toc=!1,this.version=VERSION}setSupportedProfiles(a){this.supportedProfiles=a}setDefaults(a){this.defaults={...this.defaults,...a}}async loadUrl(a,b=!1){console.log(`Loading manifest ${a}`);let c,d="string"==typeof a?a:a.href,e=d,f="";this.errors=[];try{if(f=await fetchContentType(d),"text/html"==f){let a=await fetchFile(d);if(!a)throw`Could not fetch ${d}`;let b=new DOMParser().parseFromString(a,"text/html");null!=b.querySelector("title")&&""!=b.querySelector("title").textContent&&(this.defaults.title=b.querySelector("title").textContent),this.defaults.lang=null!=b.querySelector("html")&&b.querySelector("html").hasAttribute("lang")&&""!=b.querySelector("html").getAttribute("lang")?b.querySelector("html").getAttribute("lang"):"en",this.defaults.dir=null!=b.querySelector("html")&&b.querySelector("html").hasAttribute("dir")&&""!=b.querySelector("html").getAttribute("dir")?b.querySelector("html").getAttribute("dir"):"ltr",b.querySelector("nav[role=doc-toc]")&&(this.defaults.toc=b.querySelector("nav[role=doc-toc]"));let f=b.querySelector("link[rel='publication']");if(null===f)throw"Publication link not found";let g=f.getAttribute("href");if("#"==g[0]){let a=b.querySelector(g);if(null==a)throw`Manifest at ${g} does not exist`;let d=b.querySelector("base");d&&(e=d.getAttribute("href")),c=JSON.parse(a.textContent)}else{let a=new URL(g,d),b=await fetchFile(a);c=JSON.parse(b),e=a}c.hasOwnProperty("readingOrder")||(c.readingOrder=d)}else if("application/ld+json"==f||"application/json"==f){let a=await fetchFile(d);if(!a)throw`Could not fetch ${d}`;c=JSON.parse(a)}else throw`Content type *${f}* not recognized`}catch(a){return this.errors.push({severity:"fatal",msg:`${a}`}),void console.log(a)}await this.loadJson(c,e,b,"text/html"===f?d:"")}async loadJson(a,b="",c=!1,d=""){let e=new ManifestProcessor;e.supportedProfiles=this.supportedProfiles,e.defaults=this.defaults,await e.loadJson(a,b,c,d),this.data=e.processed,this.errors=this.errors.concat(e.errors)}getFatalErrors(){return this.errors.filter(a=>"fatal"===a.severity)}getTitle(a=""){return this.getL10NStringValue(this.data.name,a)}getCover(){return this.getResource("cover")}getPageList(){return this.getResource("pagelist")}getToc(){return this.hasHtmlToc()?this.getResource("contents"):this.data.readingOrder?this.data.readingOrder.map(a=>({name:this.getL10NStringValue(a.name),url:a.url})):[]}hasHtmlToc(){return null!=this.getResource("contents")&&"text/html"==this.getResource("contents").encodingFormat}getCurrentReadingOrderItem(){return this.data.readingOrder&&this.data.readingOrder.length>this.readingOrderIndex?this.data.readingOrder[this.readingOrderIndex]:null}gotoNextReadingOrderItem(){return this.readingOrderIndex<this.data.readingOrder.length-1?(this.readingOrderIndex++,this.getCurrentReadingOrderItem()):null}gotoPrevReadingOrderItem(){return 0<this.readingOrderIndex?(this.readingOrderIndex--,this.getCurrentReadingOrderItem()):null}updateCurrentReadingOrderIndex(a){let b=-1==a.indexOf("://")?new URL(a,this.data.base):new URL(a);if(this.data.readingOrder){let a=this.data.readingOrder.findIndex(a=>a.url==b.href);if(-1!=a)return this.readingOrderIndex=a,this.getCurrentReadingOrderItem()}else return null}getResource(a){let b=this.data.resources.find(b=>!!b.rel&&b.rel.includes(a));return b?b:null}getL10NStringValue(a,b=""){if(""!=b){let c=a.find(a=>a.language===b);return c?c.value:a[0].value}if(""!=this.data.lang){let b=a.find(a=>a.language===this.data.lang);if(b)return b.value}return a[0].value}}export{Manifest};